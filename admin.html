---
layout: page
# title: "管理后台"  # 不显示在导航栏
description: "在线编辑博客文章"
header-img: "img/post-bg-desk.jpg"
---

<!-- 管理后台：在线编辑 Markdown 文章 -->
<div class="admin-wrapper">
    <!-- 登录区域 -->
    <div id="login-section" class="admin-login-card">
        <div class="login-header">
            <div class="login-icon">
                <i class="fa fa-github"></i>
            </div>
            <h2>博客管理后台</h2>
            <p class="login-subtitle">使用 GitHub Token 登录以编辑文章</p>
        </div>
        <div class="login-body">
            <div class="form-group-modern">
                <label>GitHub Personal Access Token</label>
                <input type="password" id="github-token" class="input-modern" 
                       placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                <small class="help-text">
                    <a href="https://github.com/settings/tokens" target="_blank">
                        <i class="fa fa-external-link"></i> 如何获取 Token？
                    </a>
                    <span class="help-tip">需要勾选 <code>repo</code> 权限</span>
                </small>
            </div>
            <button class="btn-modern btn-primary-modern" onclick="login()">
                <i class="fa fa-sign-in"></i> 登录
            </button>
            <div id="login-status" class="status-message"></div>
        </div>
    </div>

    <!-- 管理区域（登录后显示） -->
    <div id="admin-section" class="admin-dashboard" style="display: none;">
        
        <!-- 顶部工具栏 -->
        <div class="admin-header">
            <div class="admin-header-left">
                <h1><i class="fa fa-file-text-o"></i> 文章管理</h1>
                <p class="admin-subtitle">在线编辑和管理你的博客文章</p>
            </div>
            <div class="admin-header-right">
                <button class="btn-modern btn-secondary-modern" onclick="loadPosts()" title="刷新列表">
                    <i class="fa fa-refresh"></i>
                </button>
                <button class="btn-modern btn-success-modern" onclick="showNewPostForm()">
                    <i class="fa fa-plus"></i> 新建文章
                </button>
                <button class="btn-modern btn-warning-modern" onclick="logout()" title="退出登录">
                    <i class="fa fa-sign-out"></i> 退出
                </button>
            </div>
        </div>

        <!-- 文章列表 -->
        <div id="posts-list" class="admin-content-card">
            <div id="loading" class="loading-state">
                <div class="spinner"></div>
                <p>加载中...</p>
            </div>
            <div id="posts-content" class="posts-grid" style="display: none;"></div>
        </div>

        <!-- 编辑器模态框 -->
        <div class="modal fade" id="editor-modal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content-modern">
                    <div class="modal-header-modern">
                        <h4 class="modal-title-modern" id="editor-title">
                            <i class="fa fa-edit"></i> 编辑文章
                        </h4>
                        <button type="button" class="close-modern" data-dismiss="modal">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body-modern">
                        <form id="post-form">
                            <div class="form-row-modern">
                                <div class="form-group-modern">
                                    <label>标题 <span class="required">*</span></label>
                                    <input type="text" id="post-title" class="input-modern" required>
                                </div>
                            </div>
                            <div class="form-row-modern">
                                <div class="form-group-modern">
                                    <label>副标题</label>
                                    <input type="text" id="post-subtitle" class="input-modern">
                                </div>
                            </div>
                            <div class="form-row-modern form-row-2">
                                <div class="form-group-modern">
                                    <label>日期 <span class="required">*</span></label>
                                    <input type="date" id="post-date" class="input-modern" required>
                                </div>
                                <div class="form-group-modern">
                                    <label>作者</label>
                                    <input type="text" id="post-author" class="input-modern" 
                                           value="{{ site.title }}">
                                </div>
                            </div>
                            <div class="form-row-modern">
                                <div class="form-group-modern">
                                    <label>头图</label>
                                    <input type="text" id="post-header-img" class="input-modern" 
                                           placeholder="img/post-bg-desk.jpg">
                                </div>
                            </div>
                            <div class="form-row-modern">
                                <div class="form-group-modern">
                                    <label>标签（用逗号分隔）</label>
                                    <input type="text" id="post-tags" class="input-modern" 
                                           placeholder="标签1, 标签2">
                                </div>
                            </div>
                            <div class="form-row-modern">
                                <div class="form-group-modern">
                                    <label>内容（Markdown）<span class="required">*</span></label>
                                    <textarea id="post-content" class="textarea-modern" rows="15" required></textarea>
                                </div>
                            </div>
                            <input type="hidden" id="post-filename">
                        </form>
                    </div>
                    <div class="modal-footer-modern">
                        <button type="button" class="btn-modern btn-secondary-modern" data-dismiss="modal">
                            <i class="fa fa-times"></i> 取消
                        </button>
                        <button type="button" class="btn-modern btn-danger-modern" id="delete-btn" onclick="deletePost()" style="display: none;">
                            <i class="fa fa-trash"></i> 删除
                        </button>
                        <button type="button" class="btn-modern btn-primary-modern" onclick="savePost()">
                            <i class="fa fa-save"></i> 保存
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Markdown 编辑器样式 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>

<style>
/* 现代化后台样式 */
.admin-wrapper {
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 40px 20px;
}

/* 登录卡片 */
.admin-login-card {
    max-width: 480px;
    margin: 80px auto;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    overflow: hidden;
    animation: slideUp 0.4s ease-out;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.login-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 40px 30px;
    text-align: center;
}

.login-icon {
    font-size: 48px;
    margin-bottom: 15px;
}

.login-header h2 {
    margin: 0 0 10px 0;
    font-size: 28px;
    font-weight: 600;
}

.login-subtitle {
    margin: 0;
    opacity: 0.9;
    font-size: 14px;
}

.login-body {
    padding: 30px;
}

.form-group-modern {
    margin-bottom: 20px;
}

.form-group-modern label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #333;
    font-size: 14px;
}

.input-modern {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
    transition: all 0.3s;
    box-sizing: border-box;
}

.input-modern:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.help-text {
    display: block;
    margin-top: 6px;
    font-size: 12px;
    color: #666;
}

.help-text a {
    color: #667eea;
    text-decoration: none;
    margin-right: 10px;
}

.help-text a:hover {
    text-decoration: underline;
}

.help-tip {
    color: #999;
}

.required {
    color: #e74c3c;
}

.btn-modern {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.btn-primary-modern {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    width: 100%;
    justify-content: center;
}

.btn-primary-modern:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
}

.btn-success-modern {
    background: #10b981;
    color: white;
}

.btn-success-modern:hover {
    background: #059669;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
}

.btn-secondary-modern {
    background: #6b7280;
    color: white;
}

.btn-secondary-modern:hover {
    background: #4b5563;
}

.btn-warning-modern {
    background: #f59e0b;
    color: white;
}

.btn-warning-modern:hover {
    background: #d97706;
}

.btn-danger-modern {
    background: #ef4444;
    color: white;
}

.btn-danger-modern:hover {
    background: #dc2626;
}

.status-message {
    margin-top: 15px;
    padding: 12px;
    border-radius: 8px;
    font-size: 14px;
}

/* 管理面板 */
.admin-dashboard {
    max-width: 1200px;
    margin: 0 auto;
}

.admin-header {
    background: white;
    border-radius: 16px;
    padding: 30px;
    margin-bottom: 24px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 20px;
}

.admin-header-left h1 {
    margin: 0 0 8px 0;
    font-size: 28px;
    color: #1f2937;
    display: flex;
    align-items: center;
    gap: 12px;
}

.admin-subtitle {
    margin: 0;
    color: #6b7280;
    font-size: 14px;
}

.admin-header-right {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}

.admin-content-card {
    background: white;
    border-radius: 16px;
    padding: 30px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    min-height: 400px;
}

.loading-state {
    text-align: center;
    padding: 80px 20px;
    color: #6b7280;
}

.spinner {
    width: 48px;
    height: 48px;
    border: 4px solid #e5e7eb;
    border-top-color: #667eea;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 20px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.posts-grid {
    display: grid;
    gap: 16px;
}

.post-item-modern {
    background: #f9fafb;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s;
}

.post-item-modern:hover {
    border-color: #667eea;
    background: #f3f4f6;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
}

.post-item-modern h4 {
    margin: 0 0 10px 0;
    color: #1f2937;
    font-size: 18px;
    font-weight: 600;
}

.post-meta-modern {
    display: flex;
    gap: 16px;
    color: #6b7280;
    font-size: 13px;
    margin-top: 8px;
}

.post-meta-modern i {
    margin-right: 4px;
}

/* 模态框样式 */
.modal-content-modern {
    border-radius: 16px;
    border: none;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

.modal-header-modern {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px 30px;
    border-radius: 16px 16px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-title-modern {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
}

.close-modern {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.close-modern:hover {
    background: rgba(255,255,255,0.3);
    transform: rotate(90deg);
}

.modal-body-modern {
    padding: 30px;
}

.form-row-modern {
    display: flex;
    gap: 16px;
    margin-bottom: 20px;
}

.form-row-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
}

.textarea-modern {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 14px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    resize: vertical;
    transition: all 0.3s;
    box-sizing: border-box;
}

.textarea-modern:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.modal-footer-modern {
    padding: 20px 30px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

/* 响应式 */
@media (max-width: 768px) {
    .admin-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .admin-header-right {
        width: 100%;
    }
    
    .btn-modern {
        flex: 1;
    }
    
    .form-row-2 {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// 配置
const CONFIG = {
    owner: '{{ site.gitalk.owner }}',
    repo: '{{ site.gitalk.repo }}',
    postsPath: '_posts/'
};

let githubToken = '';
let simplemde = null;

// 初始化
$(document).ready(function() {
    // 检查是否已登录
    const savedToken = localStorage.getItem('github_token');
    if (savedToken) {
        githubToken = savedToken;
        $('#github-token').val('***已保存***');
        showAdmin();
        loadPosts();
    }

    // 初始化日期为今天
    const today = new Date().toISOString().split('T')[0];
    $('#post-date').val(today);
});

// 登录
function login() {
    const token = $('#github-token').val().trim();
    if (!token) {
        showMessage('login-status', '请输入 Token', 'danger');
        return;
    }
    
    githubToken = token;
    
    // 验证 Token
    testGitHubToken(token).then(valid => {
        if (valid) {
            localStorage.setItem('github_token', token);
            showAdmin();
            loadPosts();
            showMessage('login-status', '登录成功！', 'success');
        } else {
            showMessage('login-status', 'Token 无效，请检查权限', 'danger');
        }
    });
}

// 退出
function logout() {
    githubToken = '';
    localStorage.removeItem('github_token');
    $('#login-section').show();
    $('#admin-section').hide();
    $('#github-token').val('');
}

// 显示管理界面
function showAdmin() {
    $('#login-section').hide();
    $('#admin-section').show();
}

// 测试 GitHub Token
async function testGitHubToken(token) {
    try {
        const response = await fetch('https://api.github.com/user', {
            headers: {
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });
        return response.ok;
    } catch (e) {
        return false;
    }
}

// 加载文章列表
async function loadPosts() {
    $('#loading').show();
    $('#posts-content').hide();
    
    try {
        const files = await getPostsList();
        displayPostsList(files);
    } catch (error) {
        showMessage('posts-content', '加载失败: ' + error.message, 'danger');
    } finally {
        $('#loading').hide();
        $('#posts-content').show();
    }
}

// 获取文章列表
async function getPostsList() {
    const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.postsPath}`;
    const response = await fetch(url, {
        headers: {
            'Authorization': `token ${githubToken}`,
            'Accept': 'application/vnd.github.v3+json'
        }
    });
    
    if (!response.ok) {
        throw new Error('无法获取文章列表');
    }
    
    const files = await response.json();
    return files.filter(f => f.name.endsWith('.md'));
}

// 显示文章列表
function displayPostsList(files) {
    if (files.length === 0) {
        $('#posts-content').html('<div style="text-align: center; padding: 60px; color: #6b7280;"><i class="fa fa-file-text-o" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i><p>暂无文章，点击"新建文章"开始创作吧！</p></div>');
        return;
    }
    
    let html = '';
    files.forEach(file => {
        const date = file.name.substring(0, 10);
        const title = file.name.substring(11).replace('.md', '').replace(/-/g, ' ');
        html += `
            <div class="post-item-modern" onclick="editPost('${file.name}', '${file.sha}')">
                <h4>${title}</h4>
                <div class="post-meta-modern">
                    <span><i class="fa fa-calendar"></i> ${date}</span>
                    <span><i class="fa fa-file"></i> ${file.name}</span>
                </div>
            </div>
        `;
    });
    
    $('#posts-content').html(html);
}

// 显示新建文章表单
function showNewPostForm() {
    $('#editor-title').text('新建文章');
    $('#post-form')[0].reset();
    $('#post-filename').val('');
    $('#delete-btn').hide();
    
    const today = new Date().toISOString().split('T')[0];
    $('#post-date').val(today);
    
    // 初始化编辑器
    if (!simplemde) {
        simplemde = new SimpleMDE({
            element: document.getElementById('post-content'),
            spellChecker: false,
            placeholder: '开始编写你的文章...',
            toolbar: ['bold', 'italic', 'heading', '|', 'quote', 'code', 'table', '|', 
                     'unordered-list', 'ordered-list', '|', 'link', 'image', '|', 
                     'preview', 'side-by-side', 'fullscreen', '|', 'guide']
        });
    }
    
    $('#editor-modal').modal('show');
}

// 编辑文章
async function editPost(filename, sha) {
    try {
        const content = await getPostContent(filename, sha);
        parsePostContent(content, filename);
        
        $('#editor-title').text('编辑文章');
        $('#post-filename').val(filename);
        $('#delete-btn').show();
        
        // 初始化编辑器
        if (!simplemde) {
            simplemde = new SimpleMDE({
                element: document.getElementById('post-content'),
                spellChecker: false,
                toolbar: ['bold', 'italic', 'heading', '|', 'quote', 'code', 'table', '|', 
                         'unordered-list', 'ordered-list', '|', 'link', 'image', '|', 
                         'preview', 'side-by-side', 'fullscreen', '|', 'guide']
            });
        } else {
            simplemde.value($('#post-content').val());
        }
        
        $('#editor-modal').modal('show');
    } catch (error) {
        alert('加载文章失败: ' + error.message);
    }
}

// Base64 解码辅助函数（正确处理 UTF-8）
function base64ToUtf8(base64) {
    const binaryString = atob(base64);
    const bytes = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
    }
    return new TextDecoder('utf-8').decode(bytes);
}

// 获取文章内容
async function getPostContent(filename, sha) {
    const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/git/blobs/${sha}`;
    const response = await fetch(url, {
        headers: {
            'Authorization': `token ${githubToken}`,
            'Accept': 'application/vnd.github.v3+json'
        }
    });
    
    if (!response.ok) {
        throw new Error('无法获取文章内容');
    }
    
    const data = await response.json();
    return base64ToUtf8(data.content);
}

// 解析文章内容
function parsePostContent(content, filename) {
    // 提取 front matter
    const fmMatch = content.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
    
    if (fmMatch) {
        const fm = fmMatch[1];
        const body = fmMatch[2];
        
        // 解析 front matter
        const titleMatch = fm.match(/title:\s*["']?([^"'\n]+)["']?/);
        const subtitleMatch = fm.match(/subtitle:\s*["']?([^"'\n]+)["']?/);
        const dateMatch = fm.match(/date:\s*(\d{4}-\d{2}-\d{2})/);
        const authorMatch = fm.match(/author:\s*["']?([^"'\n]+)["']?/);
        const headerImgMatch = fm.match(/header-img:\s*["']?([^"'\n]+)["']?/);
        const tagsMatch = fm.match(/tags:\s*\n((?:\s*-\s*[^\n]+\n?)+)/);
        
        $('#post-title').val(titleMatch ? titleMatch[1].trim() : '');
        $('#post-subtitle').val(subtitleMatch ? subtitleMatch[1].trim() : '');
        $('#post-date').val(dateMatch ? dateMatch[1] : '');
        $('#post-author').val(authorMatch ? authorMatch[1].trim() : '{{ site.title }}');
        $('#post-header-img').val(headerImgMatch ? headerImgMatch[1].trim() : '');
        
        // 解析标签
        if (tagsMatch) {
            const tags = tagsMatch[1].match(/-\s*([^\n]+)/g);
            if (tags) {
                $('#post-tags').val(tags.map(t => t.replace(/^-\s*/, '')).join(', '));
            }
        }
        
        $('#post-content').val(body);
    } else {
        // 没有 front matter，使用文件名
        const date = filename.substring(0, 10);
        const title = filename.substring(11).replace('.md', '').replace(/-/g, ' ');
        $('#post-title').val(title);
        $('#post-date').val(date);
        $('#post-content').val(content);
    }
}

// 保存文章
async function savePost() {
    const title = $('#post-title').val().trim();
    const date = $('#post-date').val();
    const content = simplemde ? simplemde.value() : $('#post-content').val();
    
    if (!title || !date || !content) {
        alert('请填写必填项：标题、日期、内容');
        return;
    }
    
    // 构建 front matter
    let frontMatter = '---\n';
    frontMatter += `layout: post\n`;
    frontMatter += `title: ${title}\n`;
    
    const subtitle = $('#post-subtitle').val().trim();
    if (subtitle) {
        frontMatter += `subtitle: ${subtitle}\n`;
    }
    
    frontMatter += `date: ${date}\n`;
    
    const author = $('#post-author').val().trim();
    if (author) {
        frontMatter += `author: ${author}\n`;
    }
    
    const headerImg = $('#post-header-img').val().trim();
    if (headerImg) {
        frontMatter += `header-img: ${headerImg}\n`;
    }
    
    const tags = $('#post-tags').val().trim();
    if (tags) {
        frontMatter += `tags:\n`;
        tags.split(',').forEach(tag => {
            frontMatter += `    - ${tag.trim()}\n`;
        });
    }
    
    frontMatter += '---\n\n';
    
    const fullContent = frontMatter + content;
    
    // 生成文件名
    const filename = $('#post-filename').val() || 
                     `${date}-${title.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]/g, '')}.md`;
    
    try {
        // 获取文件 SHA（如果存在）
        let sha = null;
        try {
            const fileInfo = await getFileInfo(filename);
            sha = fileInfo.sha;
        } catch (e) {
            // 文件不存在，创建新文件
        }
        
        // 保存文件
        await saveFile(filename, fullContent, sha);
        
        $('#editor-modal').modal('hide');
        showMessage('posts-content', '保存成功！GitHub Pages 会自动更新（可能需要几分钟）', 'success');
        setTimeout(() => loadPosts(), 1000);
    } catch (error) {
        alert('保存失败: ' + error.message);
    }
}

// 获取文件信息
async function getFileInfo(filename) {
    const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.postsPath}${filename}`;
    const response = await fetch(url, {
        headers: {
            'Authorization': `token ${githubToken}`,
            'Accept': 'application/vnd.github.v3+json'
        }
    });
    
    if (!response.ok) {
        throw new Error('文件不存在');
    }
    
    return await response.json();
}

// Base64 编码辅助函数（正确处理 UTF-8）
function utf8ToBase64(str) {
    try {
        // 方法1：使用 TextEncoder（现代浏览器推荐）
        const encoder = new TextEncoder();
        const bytes = encoder.encode(str);
        // 将字节数组转换为二进制字符串
        let binary = '';
        const len = bytes.length;
        for (let i = 0; i < len; i++) {
            binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary);
    } catch (e) {
        // 方法2：降级方案（兼容旧浏览器）
        return btoa(unescape(encodeURIComponent(str)));
    }
}

// 保存文件
async function saveFile(filename, content, sha) {
    const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.postsPath}${filename}`;
    
    // 使用更可靠的 UTF-8 到 Base64 转换
    const base64Content = utf8ToBase64(content);
    
    const body = {
        message: sha ? `Update ${filename}` : `Create ${filename}`,
        content: base64Content
    };
    
    if (sha) {
        body.sha = sha;
    }
    
    const response = await fetch(url, {
        method: 'PUT',
        headers: {
            'Authorization': `token ${githubToken}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
    });
    
    if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || '保存失败');
    }
    
    return await response.json();
}

// 删除文章
async function deletePost() {
    if (!confirm('确定要删除这篇文章吗？此操作不可恢复！')) {
        return;
    }
    
    const filename = $('#post-filename').val();
    if (!filename) {
        return;
    }
    
    try {
        const fileInfo = await getFileInfo(filename);
        await deleteFile(filename, fileInfo.sha);
        
        $('#editor-modal').modal('hide');
        showMessage('posts-content', '删除成功！', 'success');
        setTimeout(() => loadPosts(), 1000);
    } catch (error) {
        alert('删除失败: ' + error.message);
    }
}

// 删除文件
async function deleteFile(filename, sha) {
    const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.postsPath}${filename}`;
    
    const response = await fetch(url, {
        method: 'DELETE',
        headers: {
            'Authorization': `token ${githubToken}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            message: `Delete ${filename}`,
            sha: sha
        })
    });
    
    if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || '删除失败');
    }
}

// 显示消息
function showMessage(containerId, message, type) {
    const bgColor = type === 'success' ? '#10b981' : 
                   type === 'danger' ? '#ef4444' : '#3b82f6';
    const icon = type === 'success' ? 'fa-check-circle' : 
                type === 'danger' ? 'fa-exclamation-circle' : 'fa-info-circle';
    $(`#${containerId}`).html(`
        <div class="status-message" style="background: ${bgColor}; color: white;">
            <i class="fa ${icon}"></i> ${message}
        </div>
    `);
    setTimeout(() => {
        $(`#${containerId}`).html('');
        if (containerId === 'posts-content') {
            loadPosts();
        }
    }, 3000);
}
</script>

