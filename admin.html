---
layout: page
title: "管理后台"
description: "在线编辑博客文章"
header-img: "img/post-bg-desk.jpg"
---

<!-- 管理后台：在线编辑 Markdown 文章 -->
<div class="admin-container" style="max-width: 1200px; margin: 0 auto; padding: 20px;">
    
    <!-- 登录区域 -->
    <div id="login-section" class="panel panel-default" style="margin-top: 50px;">
        <div class="panel-heading">
            <h3>GitHub 登录</h3>
        </div>
        <div class="panel-body">
            <p>使用 GitHub 账号登录以编辑文章</p>
            <div class="form-group">
                <label>GitHub Personal Access Token</label>
                <input type="password" id="github-token" class="form-control" 
                       placeholder="输入你的 GitHub Personal Access Token">
                <small class="help-block">
                    <a href="https://github.com/settings/tokens" target="_blank">如何获取 Token？</a>
                    需要勾选 <code>repo</code> 权限
                </small>
            </div>
            <button class="btn btn-primary" onclick="login()">登录</button>
            <div id="login-status" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- 管理区域（登录后显示） -->
    <div id="admin-section" style="display: none;">
        
        <!-- 工具栏 -->
        <div class="panel panel-default">
            <div class="panel-heading">
                <div class="row">
                    <div class="col-md-6">
                        <h3>文章管理</h3>
                    </div>
                    <div class="col-md-6 text-right">
                        <button class="btn btn-success" onclick="showNewPostForm()">
                            <i class="fa fa-plus"></i> 新建文章
                        </button>
                        <button class="btn btn-default" onclick="loadPosts()">
                            <i class="fa fa-refresh"></i> 刷新
                        </button>
                        <button class="btn btn-warning" onclick="logout()">退出</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 文章列表 -->
        <div id="posts-list" class="panel panel-default">
            <div class="panel-body">
                <div id="loading" class="text-center" style="padding: 40px;">
                    <i class="fa fa-spinner fa-spin fa-3x"></i>
                    <p>加载中...</p>
                </div>
                <div id="posts-content" style="display: none;"></div>
            </div>
        </div>

        <!-- 编辑器模态框 -->
        <div class="modal fade" id="editor-modal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title" id="editor-title">编辑文章</h4>
                    </div>
                    <div class="modal-body">
                        <form id="post-form">
                            <div class="form-group">
                                <label>标题 *</label>
                                <input type="text" id="post-title" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>副标题</label>
                                <input type="text" id="post-subtitle" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>日期 *</label>
                                <input type="date" id="post-date" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>作者</label>
                                <input type="text" id="post-author" class="form-control" 
                                       value="{{ site.title }}">
                            </div>
                            <div class="form-group">
                                <label>头图</label>
                                <input type="text" id="post-header-img" class="form-control" 
                                       placeholder="img/post-bg-desk.jpg">
                            </div>
                            <div class="form-group">
                                <label>标签（用逗号分隔）</label>
                                <input type="text" id="post-tags" class="form-control" 
                                       placeholder="标签1, 标签2">
                            </div>
                            <div class="form-group">
                                <label>内容（Markdown）*</label>
                                <textarea id="post-content" class="form-control" rows="15" required></textarea>
                            </div>
                            <input type="hidden" id="post-filename">
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" onclick="savePost()">
                            <i class="fa fa-save"></i> 保存
                        </button>
                        <button type="button" class="btn btn-danger" id="delete-btn" onclick="deletePost()" style="display: none;">
                            <i class="fa fa-trash"></i> 删除
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Markdown 编辑器样式 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
<script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>

<style>
.admin-container {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}
.post-item {
    padding: 15px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background 0.2s;
}
.post-item:hover {
    background: #f5f5f5;
}
.post-item:last-child {
    border-bottom: none;
}
.post-meta-info {
    color: #999;
    font-size: 0.9em;
    margin-top: 5px;
}
.btn-group-post {
    margin-top: 10px;
}
#post-content {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 14px;
}
</style>

<script>
// 配置
const CONFIG = {
    owner: '{{ site.gitalk.owner }}',
    repo: '{{ site.gitalk.repo }}',
    postsPath: '_posts/'
};

let githubToken = '';
let simplemde = null;

// 初始化
$(document).ready(function() {
    // 检查是否已登录
    const savedToken = localStorage.getItem('github_token');
    if (savedToken) {
        githubToken = savedToken;
        $('#github-token').val('***已保存***');
        showAdmin();
        loadPosts();
    }

    // 初始化日期为今天
    const today = new Date().toISOString().split('T')[0];
    $('#post-date').val(today);
});

// 登录
function login() {
    const token = $('#github-token').val().trim();
    if (!token) {
        showMessage('login-status', '请输入 Token', 'danger');
        return;
    }
    
    githubToken = token;
    
    // 验证 Token
    testGitHubToken(token).then(valid => {
        if (valid) {
            localStorage.setItem('github_token', token);
            showAdmin();
            loadPosts();
            showMessage('login-status', '登录成功！', 'success');
        } else {
            showMessage('login-status', 'Token 无效，请检查权限', 'danger');
        }
    });
}

// 退出
function logout() {
    githubToken = '';
    localStorage.removeItem('github_token');
    $('#login-section').show();
    $('#admin-section').hide();
    $('#github-token').val('');
}

// 显示管理界面
function showAdmin() {
    $('#login-section').hide();
    $('#admin-section').show();
}

// 测试 GitHub Token
async function testGitHubToken(token) {
    try {
        const response = await fetch('https://api.github.com/user', {
            headers: {
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github.v3+json'
            }
        });
        return response.ok;
    } catch (e) {
        return false;
    }
}

// 加载文章列表
async function loadPosts() {
    $('#loading').show();
    $('#posts-content').hide();
    
    try {
        const files = await getPostsList();
        displayPostsList(files);
    } catch (error) {
        showMessage('posts-content', '加载失败: ' + error.message, 'danger');
    } finally {
        $('#loading').hide();
        $('#posts-content').show();
    }
}

// 获取文章列表
async function getPostsList() {
    const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.postsPath}`;
    const response = await fetch(url, {
        headers: {
            'Authorization': `token ${githubToken}`,
            'Accept': 'application/vnd.github.v3+json'
        }
    });
    
    if (!response.ok) {
        throw new Error('无法获取文章列表');
    }
    
    const files = await response.json();
    return files.filter(f => f.name.endsWith('.md'));
}

// 显示文章列表
function displayPostsList(files) {
    if (files.length === 0) {
        $('#posts-content').html('<p class="text-center">暂无文章</p>');
        return;
    }
    
    let html = '';
    files.forEach(file => {
        const date = file.name.substring(0, 10);
        const title = file.name.substring(11).replace('.md', '');
        html += `
            <div class="post-item" onclick="editPost('${file.name}', '${file.sha}')">
                <h4>${title}</h4>
                <div class="post-meta-info">
                    <i class="fa fa-calendar"></i> ${date} | 
                    <i class="fa fa-file"></i> ${file.name}
                </div>
            </div>
        `;
    });
    
    $('#posts-content').html(html);
}

// 显示新建文章表单
function showNewPostForm() {
    $('#editor-title').text('新建文章');
    $('#post-form')[0].reset();
    $('#post-filename').val('');
    $('#delete-btn').hide();
    
    const today = new Date().toISOString().split('T')[0];
    $('#post-date').val(today);
    
    // 初始化编辑器
    if (!simplemde) {
        simplemde = new SimpleMDE({
            element: document.getElementById('post-content'),
            spellChecker: false,
            placeholder: '开始编写你的文章...',
            toolbar: ['bold', 'italic', 'heading', '|', 'quote', 'code', 'table', '|', 
                     'unordered-list', 'ordered-list', '|', 'link', 'image', '|', 
                     'preview', 'side-by-side', 'fullscreen', '|', 'guide']
        });
    }
    
    $('#editor-modal').modal('show');
}

// 编辑文章
async function editPost(filename, sha) {
    try {
        const content = await getPostContent(filename, sha);
        parsePostContent(content, filename);
        
        $('#editor-title').text('编辑文章');
        $('#post-filename').val(filename);
        $('#delete-btn').show();
        
        // 初始化编辑器
        if (!simplemde) {
            simplemde = new SimpleMDE({
                element: document.getElementById('post-content'),
                spellChecker: false,
                toolbar: ['bold', 'italic', 'heading', '|', 'quote', 'code', 'table', '|', 
                         'unordered-list', 'ordered-list', '|', 'link', 'image', '|', 
                         'preview', 'side-by-side', 'fullscreen', '|', 'guide']
            });
        } else {
            simplemde.value($('#post-content').val());
        }
        
        $('#editor-modal').modal('show');
    } catch (error) {
        alert('加载文章失败: ' + error.message);
    }
}

// 获取文章内容
async function getPostContent(filename, sha) {
    const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/git/blobs/${sha}`;
    const response = await fetch(url, {
        headers: {
            'Authorization': `token ${githubToken}`,
            'Accept': 'application/vnd.github.v3+json'
        }
    });
    
    if (!response.ok) {
        throw new Error('无法获取文章内容');
    }
    
    const data = await response.json();
    return atob(data.content);
}

// 解析文章内容
function parsePostContent(content, filename) {
    // 提取 front matter
    const fmMatch = content.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
    
    if (fmMatch) {
        const fm = fmMatch[1];
        const body = fmMatch[2];
        
        // 解析 front matter
        const titleMatch = fm.match(/title:\s*["']?([^"'\n]+)["']?/);
        const subtitleMatch = fm.match(/subtitle:\s*["']?([^"'\n]+)["']?/);
        const dateMatch = fm.match(/date:\s*(\d{4}-\d{2}-\d{2})/);
        const authorMatch = fm.match(/author:\s*["']?([^"'\n]+)["']?/);
        const headerImgMatch = fm.match(/header-img:\s*["']?([^"'\n]+)["']?/);
        const tagsMatch = fm.match(/tags:\s*\n((?:\s*-\s*[^\n]+\n?)+)/);
        
        $('#post-title').val(titleMatch ? titleMatch[1].trim() : '');
        $('#post-subtitle').val(subtitleMatch ? subtitleMatch[1].trim() : '');
        $('#post-date').val(dateMatch ? dateMatch[1] : '');
        $('#post-author').val(authorMatch ? authorMatch[1].trim() : '{{ site.title }}');
        $('#post-header-img').val(headerImgMatch ? headerImgMatch[1].trim() : '');
        
        // 解析标签
        if (tagsMatch) {
            const tags = tagsMatch[1].match(/-\s*([^\n]+)/g);
            if (tags) {
                $('#post-tags').val(tags.map(t => t.replace(/^-\s*/, '')).join(', '));
            }
        }
        
        $('#post-content').val(body);
    } else {
        // 没有 front matter，使用文件名
        const date = filename.substring(0, 10);
        const title = filename.substring(11).replace('.md', '').replace(/-/g, ' ');
        $('#post-title').val(title);
        $('#post-date').val(date);
        $('#post-content').val(content);
    }
}

// 保存文章
async function savePost() {
    const title = $('#post-title').val().trim();
    const date = $('#post-date').val();
    const content = simplemde ? simplemde.value() : $('#post-content').val();
    
    if (!title || !date || !content) {
        alert('请填写必填项：标题、日期、内容');
        return;
    }
    
    // 构建 front matter
    let frontMatter = '---\n';
    frontMatter += `layout: post\n`;
    frontMatter += `title: ${title}\n`;
    
    const subtitle = $('#post-subtitle').val().trim();
    if (subtitle) {
        frontMatter += `subtitle: ${subtitle}\n`;
    }
    
    frontMatter += `date: ${date}\n`;
    
    const author = $('#post-author').val().trim();
    if (author) {
        frontMatter += `author: ${author}\n`;
    }
    
    const headerImg = $('#post-header-img').val().trim();
    if (headerImg) {
        frontMatter += `header-img: ${headerImg}\n`;
    }
    
    const tags = $('#post-tags').val().trim();
    if (tags) {
        frontMatter += `tags:\n`;
        tags.split(',').forEach(tag => {
            frontMatter += `    - ${tag.trim()}\n`;
        });
    }
    
    frontMatter += '---\n\n';
    
    const fullContent = frontMatter + content;
    
    // 生成文件名
    const filename = $('#post-filename').val() || 
                     `${date}-${title.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]/g, '')}.md`;
    
    try {
        // 获取文件 SHA（如果存在）
        let sha = null;
        try {
            const fileInfo = await getFileInfo(filename);
            sha = fileInfo.sha;
        } catch (e) {
            // 文件不存在，创建新文件
        }
        
        // 保存文件
        await saveFile(filename, fullContent, sha);
        
        $('#editor-modal').modal('hide');
        showMessage('posts-content', '保存成功！GitHub Pages 会自动更新（可能需要几分钟）', 'success');
        setTimeout(() => loadPosts(), 1000);
    } catch (error) {
        alert('保存失败: ' + error.message);
    }
}

// 获取文件信息
async function getFileInfo(filename) {
    const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.postsPath}${filename}`;
    const response = await fetch(url, {
        headers: {
            'Authorization': `token ${githubToken}`,
            'Accept': 'application/vnd.github.v3+json'
        }
    });
    
    if (!response.ok) {
        throw new Error('文件不存在');
    }
    
    return await response.json();
}

// 保存文件
async function saveFile(filename, content, sha) {
    const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.postsPath}${filename}`;
    
    const body = {
        message: sha ? `Update ${filename}` : `Create ${filename}`,
        content: btoa(unescape(encodeURIComponent(content)))
    };
    
    if (sha) {
        body.sha = sha;
    }
    
    const response = await fetch(url, {
        method: 'PUT',
        headers: {
            'Authorization': `token ${githubToken}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
    });
    
    if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || '保存失败');
    }
    
    return await response.json();
}

// 删除文章
async function deletePost() {
    if (!confirm('确定要删除这篇文章吗？此操作不可恢复！')) {
        return;
    }
    
    const filename = $('#post-filename').val();
    if (!filename) {
        return;
    }
    
    try {
        const fileInfo = await getFileInfo(filename);
        await deleteFile(filename, fileInfo.sha);
        
        $('#editor-modal').modal('hide');
        showMessage('posts-content', '删除成功！', 'success');
        setTimeout(() => loadPosts(), 1000);
    } catch (error) {
        alert('删除失败: ' + error.message);
    }
}

// 删除文件
async function deleteFile(filename, sha) {
    const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.postsPath}${filename}`;
    
    const response = await fetch(url, {
        method: 'DELETE',
        headers: {
            'Authorization': `token ${githubToken}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            message: `Delete ${filename}`,
            sha: sha
        })
    });
    
    if (!response.ok) {
        const error = await response.json();
        throw new Error(error.message || '删除失败');
    }
}

// 显示消息
function showMessage(containerId, message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 
                      type === 'danger' ? 'alert-danger' : 'alert-info';
    $(`#${containerId}`).html(`<div class="alert ${alertClass}">${message}</div>`);
    setTimeout(() => {
        if (containerId === 'posts-content') {
            loadPosts();
        }
    }, 3000);
}
</script>

